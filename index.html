<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF-Аналізатор UA</title>
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.18/dist/web-llm.js"></script>
  <style>
    /* Inline стилі для гарантії завантаження (копія з styles.css) */
    :root {
      --primary-bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --dark-bg: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      --primary-color: #007bff;
      --accent-gradient: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --dark-glass: rgba(0, 0, 0, 0.2);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    body.light-theme { background: var(--primary-bg); color: #333; }
    body.dark-theme { background: var(--dark-bg); color: #f0f0f0; }
    body.dark-theme .glass-card { background: var(--dark-glass); border: 1px solid rgba(255, 255, 255, 0.1); }
    .theme-toggle { position: fixed; top: 20px; right: 20px; z-index: 1000; cursor: pointer; font-size: 24px; color: var(--primary-color); transition: var(--transition); }
    .theme-toggle:hover { transform: rotate(180deg) scale(1.2); }
    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; display: grid; gap: 20px; align-items: center; }
    h1 { text-align: center; color: var(--primary-color); text-shadow: 1px 1px 2px rgba(0,0,0,0.1); font-size: 2em; margin-bottom: 0; animation: fadeInDown 1s ease-out; }
    @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    .upload-area { position: relative; display: grid; place-items: center; }
    #pdfInput { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
    label[for="pdfInput"] { padding: 40px; border: 2px dashed var(--primary-color); border-radius: 12px; text-align: center; cursor: pointer; transition: var(--transition); background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
    label[for="pdfInput"]:hover { background: rgba(0, 123, 255, 0.1); transform: scale(1.02); border-color: #0056b3; }
    body.dark-theme label[for="pdfInput"] { background: rgba(0, 0, 0, 0.3); }
    input[type="text"] { padding: 15px; border-radius: 25px; border: 1px solid rgba(0, 0, 0, 0.1); background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); transition: var(--transition); box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
    input[type="text"]:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1); outline: none; }
    body.dark-theme input[type="text"] { background: rgba(0, 0, 0, 0.5); color: #f0f0f0; border-color: rgba(255, 255, 255, 0.2); }
    button { padding: 15px 30px; border-radius: 25px; background: var(--accent-gradient); color: white; border: none; cursor: pointer; font-weight: bold; font-size: 16px; transition: var(--transition); box-shadow: var(--shadow); position: relative; overflow: hidden; }
    button::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); transition: left 0.5s; }
    button:hover::before { left: 100%; }
    button:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
    button:active { animation: wave 0.6s ease-out; }
    @keyframes wave { 0% { transform: scale(1); } 50% { transform: scale(0.98); } 100% { transform: scale(1); } }
    #loading { text-align: center; color: var(--primary-color); font-weight: bold; display: none; margin: 20px; padding: 20px; border-radius: 10px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); animation: fadeIn 0.5s ease-out; }
    body.dark-theme #loading { background: rgba(0, 0, 0, 0.3); }
    .spinner { border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .progress-bar { width: 100%; height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; margin: 10px 0; display: none; }
    .progress-fill { height: 100%; background: var(--accent-gradient); width: 0%; transition: width 0.3s ease; animation: progressWave 2s ease-in-out infinite; }
    @keyframes progressWave { 0%, 100% { box-shadow: 0 0 5px rgba(255, 107, 107, 0.5); } 50% { box-shadow: 0 0 20px rgba(78, 205, 196, 0.8); } }
    #result { margin-top: 20px; padding: 20px; border-radius: 15px; background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: var(--shadow); height: 300px; overflow-y: auto; display: none; animation: glassSlideIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
    @keyframes glassSlideIn { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    body.dark-theme #result { background: var(--dark-glass); border: 1px solid rgba(255, 255, 255, 0.1); }
    .install-link { display: block; text-align: center; margin-top: 20px; color: var(--primary-color); text-decoration: none; font-weight: bold; transition: var(--transition); padding: 10px; border-radius: 8px; background: rgba(255, 255, 255, 0.8); }
    .install-link:hover { background: rgba(0, 123, 255, 0.1); transform: scale(1.05); }
    body.dark-theme .install-link { background: rgba(0, 0, 0, 0.3); }
    .hidden { display: none !important; }
    .error-shake { animation: shake 0.5s ease-in-out; }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    @media (max-width: 600px) { .container { padding: 20px; } h1 { font-size: 1.5em; } }
  </style>
</head>
<body class="light-theme">
  <div class="theme-toggle">
    <i class="fas fa-moon" onclick="toggleTheme()"></i>
  </div>
  <div class="container">
    <h1><i class="fas fa-file-pdf"></i> PDF-Аналізатор UA</h1>
    <div class="upload-area">
      <input type="file" id="pdfInput" accept=".pdf" />
      <label for="pdfInput"><i class="fas fa-cloud-upload-alt"></i> Обери PDF-файл</label>
    </div>
    <input type="text" id="keywordsInput" placeholder="Ключові слова (через кому, напр. екологія, реформи)" />
    <button onclick="analyzePDF()"><i class="fas fa-search"></i> Аналізувати</button>
    <a href="install.html" class="install-link"><i class="fas fa-mobile-alt"></i> Як встановити на Android</a>
    <div id="loading" class="hidden">
      <div class="spinner"></div>
      Завантажую модель LLM...
    </div>
    <div class="progress-bar hidden" id="progressBar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div id="result" class="glass-card hidden"></div>
  </div>
  <script>
    // Inline app.js для гарантії (логіка аналізу)
    let llm = null;
    let pdfText = '';

    async function initLLM() {
      const loading = document.getElementById('loading');
      loading.classList.remove('hidden');
      loading.innerHTML = '<div class="spinner"></div>Завантажую модель LLM...';

      try {
        const selectedModel = await webllm.GetWebLLMModel('Gemma-2B-2bit');
        llm = await selectedModel.create();
        loading.innerHTML = '<div class="spinner"></div>Модель готова!';
        setTimeout(() => loading.classList.add('hidden'), 1000);
      } catch (error) {
        console.error('LLM error:', error);
        loading.innerHTML = 'Fallback-режим (базовий аналіз без AI)';
        setTimeout(() => loading.classList.add('hidden'), 2000);
        llm = null;
      }
    }

    async function analyzePDF() {
      const fileInput = document.getElementById('pdfInput');
      const file = fileInput.files[0];
      if (!file) {
        fileInput.classList.add('error-shake');
        setTimeout(() => fileInput.classList.remove('error-shake'), 500);
        return alert('Обери PDF!');
      }

      const loading = document.getElementById('loading');
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      const result = document.getElementById('result');
      loading.classList.remove('hidden');
      progressBar.classList.remove('hidden');
      loading.innerHTML = '<div class="spinner"></div>Парсю PDF...';

      try {
        const arrayBuffer = await file.arrayBuffer();
        const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
        const pdf = await loadingTask.promise;
        pdfText = '';
        const totalPages = pdf.numPages;
        for (let i = 1; i <= totalPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          pdfText += textContent.items.map(item => item.str).join(' ') + '\n--- Сторінка ' + i + ' ---\n';
          
          const progress = (i / totalPages) * 100;
          progressFill.style.width = progress + '%';
          loading.innerHTML = `<div class="spinner"></div>Обробляю сторінку ${i}/${totalPages}...`;
        }

        const keywords = document.getElementById('keywordsInput').value;

        // Спрощення тексту
        let simplified = pdfText.replace(/гіперінфляція/gi, 'швидке зростання цін')
                                .replace(/зміна клімату/gi, 'глобальне потепління')
                                .replace(/екологічна політика/gi, 'правила для захисту природи');

        let summary = '';
        let matches = '';

        loading.innerHTML = '<div class="spinner"></div>Генерую переказ та пошук...';
        progressFill.style.width = '100%';

        if (llm) {
          const summaryPrompt = `Зроби короткий переказ тексту українською (3 речення, простими словами): ${pdfText.substring(0, 2000)}`;
          const summaryReply = await llm.chat.completions.create({ messages: [{ role: 'user', content: summaryPrompt }], max_tokens: 150 });
          summary = summaryReply.choices[0].message.content;

          const searchPrompt = `Знайди співпадіння по ключам "${keywords}" у тексті, вкажи сторінки та пов'язані терміни українською: ${pdfText}`;
          const searchReply = await llm.chat.completions.create({ messages: [{ role: 'user', content: searchPrompt }], max_tokens: 200 });
          matches = searchReply.choices[0].message.content;
        } else {
          // Fallback
          const sentences = pdfText.split(/[\.\!\?]\s+/).slice(0, 3).join('. ');
          summary = `Короткий переказ (fallback): ${sentences}.`;

          const sections = pdfText.split(/--- Сторінка \d+ ---/);
          keywords.split(',').forEach(kw => {
            const lowerKw = kw.trim().toLowerCase();
            for (let i = 0; i < sections.length; i++) {
              if (sections[i].toLowerCase().includes(lowerKw)) {
                const related = sections[i].substring(0, 100).match(/\b\w+\b/g)?.slice(0,3).join(', ') || 'немає';
                matches += `${kw}: Знайдено на сторінці ${i+1} (пов'язані: ${related})\n`;
                return;
              }
            }
            matches += `${kw}: Не знайдено\n`;
          });
        }

        result.innerHTML = `
          <strong>Спрощений текст (перші 500 символів):</strong> ${simplified.substring(0, 500)}...<br>
          <strong>Переказ:</strong> ${summary}<br>
          <strong>Співпадіння по ключам:</strong> <pre>${matches}</pre>
        `;
        result.classList.remove('hidden');
      } catch (error) {
        result.innerHTML = `Помилка: ${error.message}`;
        result.classList.add('error-shake');
        setTimeout(() => result.classList.remove('error-shake'), 500);
      } finally {
        loading.classList.add('hidden');
        progressBar.classList.add('hidden');
        progressFill.style.width = '0%';
      }
    }

    function toggleTheme() {
      document.body.classList.toggle('dark-theme');
      const icon = document.querySelector('.theme-toggle i');
      icon.classList.toggle('fa-moon');
      icon.classList.toggle('fa-sun');
      localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
    }

    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark-theme');
      document.querySelector('.theme-toggle i').classList.replace('fa-moon', 'fa-sun');
    }

    initLLM();
  </script>
  <script>
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
  </script>
</body>
</html>
